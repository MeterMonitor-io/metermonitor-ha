name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write        # to push to main + create GitHub Release
  packages: write        # to push to GHCR
  actions: read

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive version from tag
        id: v
        run: |
          TAG="${GITHUB_REF_NAME}"      # e.g. v4.0.0
          VERSION="${TAG#v}"            # 4.0.0
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Ensure tag commit is on develop
        run: |
          git fetch origin develop
          if ! git branch -r --contains "$GITHUB_SHA" | grep -q "origin/develop"; then
            echo "Tag commit is not contained in develop. Aborting."
            exit 1
          fi

      # ---- run tests again (or call reusable workflow) ----
      - name: Run tests
        run: |
          echo "Run your tests here"
          # exit nonzero if tests fail

      # ---- promote to main + bump config.json there ----
      - name: Configure git author
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"

      - name: Promote develop -> main (fast-forward or merge)
        run: |
          git fetch origin main develop
          git checkout main
          # Option A: fast-forward only (clean history)
          git merge --ff-only origin/develop

      - name: Bump config.json version on main
        run: |
          VERSION="${{ steps.v.outputs.version }}"
          jq --arg v "$VERSION" '.version=$v' config.json > config.json.tmp
          mv config.json.tmp config.json

          git add config.json
          git commit -m "Release $VERSION"
          git push origin main

      # ---- build & push image to GHCR (linked to repo) ----
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata (IMPORTANT for linking)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/metermonitor-ha
          tags: |
            type=raw,value=${{ steps.v.outputs.version }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=MeterMonitor HA Add-on
            org.opencontainers.image.description=Home Assistant add-on for MeterMonitor
            org.opencontainers.image.source=https://github.com/MeterMonitor-io/metermonitor-ha
            org.opencontainers.image.url=https://github.com/MeterMonitor-io/metermonitor-ha
            org.opencontainers.image.documentation=https://github.com/MeterMonitor-io/metermonitor-ha
            org.opencontainers.image.version=${{ steps.v.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # ---- create GitHub Release for the tag ----
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
