<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 750" style="background: #0d1117;">
  <defs>
    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#58a6ff" />
    </marker>
    <marker id="arrowhead-red" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto">
      <polygon points="0 0, 8 3, 0 6" fill="#f85149" />
    </marker>
  <style>
  text { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; }
</style></defs>

  
  <rect x="50" y="30" width="220" height="90" rx="8" fill="#161b22" stroke="#58a6ff" stroke-width="1.5" />
  <text x="160" y="58" font-size="15" font-weight="700" fill="#58a6ff" text-anchor="middle">Image Sources</text>
  <text x="160" y="80" font-size="11" fill="#c9d1d9" text-anchor="middle">MQTT / HTTP / HA Camera</text>
  <text x="160" y="100" font-size="11" fill="#8b949e" text-anchor="middle">Polling or Push</text>

  
  <path d="M 270 75 L 330 75" stroke="#8b949e" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />

  
  <rect x="330" y="30" width="220" height="90" rx="8" fill="#161b22" stroke="#3fb950" stroke-width="1.5" />
  <text x="440" y="58" font-size="15" font-weight="700" fill="#3fb950" text-anchor="middle">ROI Extraction</text>
  <text x="440" y="80" font-size="11" fill="#c9d1d9" text-anchor="middle">YOLO / ORB / Static Rect</text>
  <text x="440" y="100" font-size="11" fill="#8b949e" text-anchor="middle">Isolate display area</text>

  
  <path d="M 550 75 L 610 75" stroke="#8b949e" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />

  
  <rect x="610" y="30" width="220" height="90" rx="8" fill="#161b22" stroke="#d29922" stroke-width="1.5" />
  <text x="720" y="58" font-size="15" font-weight="700" fill="#d29922" text-anchor="middle">Segmentation</text>
  <text x="720" y="80" font-size="11" fill="#c9d1d9" text-anchor="middle">Thresholding &amp; separation</text>
  <text x="720" y="100" font-size="11" fill="#8b949e" text-anchor="middle">7-Segment Digits</text>

  
  <path d="M 830 75 L 890 75" stroke="#8b949e" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />

  
  <rect x="890" y="30" width="220" height="90" rx="8" fill="#161b22" stroke="#a371f7" stroke-width="1.5" />
  <text x="1000" y="58" font-size="15" font-weight="700" fill="#a371f7" text-anchor="middle">CNN Classification</text>
  <text x="1000" y="80" font-size="11" fill="#c9d1d9" text-anchor="middle">Digit recognition</text>
  <text x="1000" y="100" font-size="11" fill="#8b949e" text-anchor="middle">Top-N predictions</text>

  
  <path d="M 1000 120 L 1000 170" stroke="#8b949e" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />

  
  <rect x="50" y="170" width="1100" height="370" rx="8" fill="#161b22" stroke="#30363d" stroke-width="1.5" />
  <text x="600" y="200" font-size="17" font-weight="700" fill="#f85149" text-anchor="middle">Smart Correction Algorithm</text>

  
  <g id="correction-left">
    
    <circle cx="80" cy="240" r="5" fill="#58a6ff" />
    <text x="100" y="244" font-size="13" font-weight="700" fill="#58a6ff" text-anchor="start">1. Time-Delta Calculation</text>
    <text x="100" y="262" font-size="11" fill="#8b949e" text-anchor="start">Calculate time difference to last accepted value</text>
    <text x="100" y="278" font-size="10" fill="#8b949e" text-anchor="start">Δt = current_timestamp - last_history_timestamp</text>

    
    <circle cx="80" cy="310" r="5" fill="#58a6ff" />
    <text x="100" y="314" font-size="13" font-weight="700" fill="#58a6ff" text-anchor="start">2. Flow-Rate Validation</text>
    <text x="100" y="332" font-size="11" fill="#8b949e" text-anchor="start">Check Δm³/Δt against max_flow_rate</text>
    <text x="100" y="348" font-size="10" fill="#8b949e" text-anchor="start">if (Δvalue / Δt) &gt; max_flow_rate → REJECT</text>

    
    <circle cx="80" cy="380" r="5" fill="#58a6ff" />
    <text x="100" y="384" font-size="13" font-weight="700" fill="#58a6ff" text-anchor="start">3. Negative-Rate Handling</text>
    <text x="100" y="402" font-size="11" fill="#8b949e" text-anchor="start">Handle decreasing meter values</text>
    <text x="100" y="418" font-size="10" fill="#8b949e" text-anchor="start">if value &lt; last_value: check allow_negative_correction</text>
    <text x="100" y="434" font-size="10" fill="#8b949e" text-anchor="start">Negative correction = single digit misread (e.g., 9→8)</text>
  </g>

  
  <g id="correction-right">
    
    <circle cx="620" cy="240" r="5" fill="#58a6ff" />
    <text x="640" y="244" font-size="13" font-weight="700" fill="#58a6ff" text-anchor="start">4. Fallback Prediction Search</text>
    <text x="640" y="262" font-size="11" fill="#8b949e" text-anchor="start">Search Top-N predictions for plausible alternative</text>
    <text x="640" y="278" font-size="10" fill="#8b949e" text-anchor="start">Example: "8" vs "9" → choose prediction with lower Δ</text>
    <text x="640" y="294" font-size="10" fill="#8b949e" text-anchor="start">Iterate through prediction combinations to find valid value</text>

    
    <circle cx="620" cy="330" r="5" fill="#58a6ff" />
    <text x="640" y="334" font-size="13" font-weight="700" fill="#58a6ff" text-anchor="start">5. Confidence Threshold Check</text>
    <text x="640" y="352" font-size="11" fill="#8b949e" text-anchor="start">Reject if overall confidence too low</text>
    <text x="640" y="368" font-size="10" fill="#8b949e" text-anchor="start">if total_confidence &lt; conf_threshold → REJECT</text>
    <text x="640" y="384" font-size="10" fill="#8b949e" text-anchor="start">Prevents accepting uncertain readings</text>
  </g>

  
  <g id="decisions">
    
    <rect x="90" y="465" width="480" height="60" rx="8" fill="#161b22" stroke="#3fb950" stroke-width="1.5" />
    <text x="330" y="490" font-size="14" font-weight="700" fill="#3fb950" text-anchor="middle">✓ ACCEPTED</text>
    <text x="330" y="510" font-size="11" fill="#3fb950" text-anchor="middle">→ Save to history • Publish via MQTT (if setup=1)</text>

    
    <rect x="600" y="465" width="480" height="60" rx="8" fill="#161b22" stroke="#f85149" stroke-width="1.5" />
    <text x="840" y="490" font-size="14" font-weight="700" fill="#f85149" text-anchor="middle">✗ REJECTED</text>
    <text x="840" y="510" font-size="11" fill="#f85149" text-anchor="middle">→ Save to evaluations with rejection_reason • No MQTT publish</text>
  </g>

  
  <path d="M 330 525 L 330 575" stroke="#8b949e" stroke-width="2" fill="none" marker-end="url(#arrowhead)" />
  <path d="M 840 525 L 840 575" stroke="#f85149" stroke-width="2" fill="none" marker-end="url(#arrowhead-red)" stroke-dasharray="4,4" />

  
  <rect x="50" y="575" width="1100" height="100" rx="8" fill="#161b22" stroke="#30363d" stroke-width="1.5" />
  <text x="600" y="605" font-size="16" font-weight="700" fill="#c9d1d9" text-anchor="middle">Publish &amp; Store</text>
  <text x="200" y="635" font-size="12" fill="#8b949e" text-anchor="start">• SQLite Database (history, evaluations)</text>
  <text x="200" y="655" font-size="12" fill="#8b949e" text-anchor="start">• MQTT Broker (Home Assistant Discovery)</text>
  <text x="650" y="635" font-size="12" fill="#8b949e" text-anchor="start">• Bounding Box Visualization</text>
  <text x="650" y="655" font-size="12" fill="#8b949e" text-anchor="start">• Web UI Real-time Update</text>

  
  <text x="50" y="710" font-size="11" fill="#8b949e" text-anchor="start">Data flow: Image Capture → ROI Extraction → Digit Segmentation → CNN Classification → Correction Algorithm → Validation → Publication</text>
  <text x="50" y="730" font-size="10" fill="#8b949e" text-anchor="start">The correction algorithm uses historical data, timestamps, and confidence scores for plausibility validation</text>
</svg>